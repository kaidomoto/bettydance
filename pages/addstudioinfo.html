<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Betty Dance - Studio 管理</title>
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background: #fffbe6;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 30px;
        }
        h1 {
            color: #e67e22;
            text-align: center;
            margin-bottom: 30px;
        }
        .studio-form {
            background: #fdf6e3;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background: #e67e22;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #cf711f;
        }
        .room-section {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            background: white;
        }
        .room-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .remove-room {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .room-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .studio-list {
            margin-top: 30px;
        }
        .studio-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 4px;
            border-left: 4px solid #e67e22;
        }
        .studio-name {
            font-weight: bold;
            color: #e67e22;
            margin-bottom: 10px;
        }
        .room-item {
            background: white;
            padding: 8px;
            margin: 5px 0;
            border-radius: 3px;
            border: 1px solid #eee;
        }
        .export-section {
            margin-top: 30px;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 6px;
        }
        .code-output {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>�� Betty Dance Studio 管理</h1>
        
        <div class="studio-form">
            <h2>添加新 Studio</h2>
            <div class="form-group">
                <label>Studio 名称:</label>
                <input type="text" id="studioName" placeholder="例如: BUZZ池袋西口PARK">
            </div>
            <div class="form-group">
                <label>Studio 简称:</label>
                <input type="text" id="studioShortName" placeholder="例如: 池袋PARK">
            </div>
            <div class="form-group">
                <label>地址:</label>
                <input type="text" id="studioAddress" placeholder="例如: 池袋駅1b出口 徒歩2分">
            </div>
            
            <h3>房间信息</h3>
            <div id="roomsContainer">
                <!-- 房间会动态添加到这里 -->
            </div>
            <button onclick="addRoom()" style="margin-top: 10px;">+ 添加房间</button>
            
            <button onclick="saveStudio()" style="margin-top: 20px;">保存 Studio</button>
        </div>
        
        <div class="studio-list">
            <h2>已保存的 Studio</h2>
            <div id="studioList">
                <!-- Studio 列表会显示在这里 -->
            </div>
        </div>
        
        <div class="export-section">
            <h2>导出代码</h2>
            <p>点击下面的按钮生成可以直接复制到 bookingdata.ts 的代码：</p>
            <button onclick="generateCode()">生成 TypeScript 代码</button>
            <button onclick="updateBookingData()" style="background: #28a745; margin-left: 10px;">自动更新 bookingdata.ts</button>
            <div class="code-output" id="codeOutput"></div>
        </div>
    </div>

    <script>
        let studios = JSON.parse(localStorage.getItem('bettyStudios') || '[]');
        let roomCounter = 0;

        function addRoom() {
            const container = document.getElementById('roomsContainer');
            const roomDiv = document.createElement('div');
            roomDiv.className = 'room-section';
            roomDiv.innerHTML = `
                <div class="room-header">
                    <h4>房间 ${++roomCounter}</h4>
                    <button class="remove-room" onclick="removeRoom(this)">删除</button>
                </div>
                <div class="room-grid">
                    <div class="form-group">
                        <label>房间号:</label>
                        <input type="text" class="room-number" placeholder="例如: D, 101">
                    </div>
                    <div class="form-group">
                        <label>房间面积 (m²):</label>
                        <input type="number" class="room-size" placeholder="例如: 25.0">
                    </div>
                    <div class="form-group">
                        <label>最大容量 (总人数):</label>
                        <input type="number" class="room-capacity" placeholder="例如: 8">
                    </div>
                    <div class="form-group">
                        <label>晚上价格 (円/小时):</label>
                        <input type="number" class="room-price" placeholder="例如: 1100">
                    </div>
                </div>
            `;
            container.appendChild(roomDiv);
        }

        function removeRoom(button) {
            button.parentElement.parentElement.remove();
        }

        function saveStudio() {
            const studioName = document.getElementById('studioName').value;
            const studioShortName = document.getElementById('studioShortName').value;
            const studioAddress = document.getElementById('studioAddress').value;
            
            if (!studioName) {
                alert('请输入 Studio 名称');
                return;
            }

            const rooms = [];
            const roomSections = document.querySelectorAll('.room-section');
            roomSections.forEach(section => {
                const roomNumber = section.querySelector('.room-number').value;
                const roomSize = section.querySelector('.room-size').value;
                const roomCapacity = section.querySelector('.room-capacity').value;
                const roomPrice = section.querySelector('.room-price').value;
                
                if (roomNumber && roomSize && roomCapacity && roomPrice) {
                    rooms.push({
                        number: roomNumber,
                        size: parseFloat(roomSize),
                        capacity: parseInt(roomCapacity),
                        price: parseInt(roomPrice)
                    });
                }
            });

            const studio = {
                name: studioName,
                shortName: studioShortName,
                address: studioAddress,
                rooms: rooms
            };

            // 检查是否已存在
            const existingIndex = studios.findIndex(s => s.name === studioName);
            if (existingIndex >= 0) {
                studios[existingIndex] = studio;
            } else {
                studios.push(studio);
            }

            localStorage.setItem('bettyStudios', JSON.stringify(studios));
            displayStudios();
            clearForm();
            alert('Studio 保存成功！');
        }

        function displayStudios() {
            const container = document.getElementById('studioList');
            container.innerHTML = '';
            
            studios.forEach((studio, index) => {
                const studioDiv = document.createElement('div');
                studioDiv.className = 'studio-item';
                studioDiv.innerHTML = `
                    <div class="studio-name">${studio.name}</div>
                    <div><strong>简称:</strong> ${studio.shortName || '未设置'}</div>
                    <div><strong>地址:</strong> ${studio.address || '未设置'}</div>
                    <div><strong>房间:</strong></div>
                    ${studio.rooms.map(room => `
                        <div class="room-item">
                            ${room.number} - ${room.size}m² - 最大${room.capacity}人 - ${room.price}円/小时
                        </div>
                    `).join('')}
                    <button onclick="deleteStudio(${index})" style="background: #dc3545; margin-top: 10px;">删除</button>
                `;
                container.appendChild(studioDiv);
            });
        }

        function deleteStudio(index) {
            if (confirm('确定要删除这个 Studio 吗？')) {
                studios.splice(index, 1);
                localStorage.setItem('bettyStudios', JSON.stringify(studios));
                displayStudios();
            }
        }

        function clearForm() {
            document.getElementById('studioName').value = '';
            document.getElementById('studioShortName').value = '';
            document.getElementById('studioAddress').value = '';
            document.getElementById('roomsContainer').innerHTML = '';
            roomCounter = 0;
        }

        function generateCode() {
            let code = `// 自动生成的 Studio 配置代码
// 复制以下代码到 bookingdata.ts 中

// 业务逻辑：根据 Studio 和 Room 判断 Studio cost（使用晚上价格）
function getStudioCost(studio: string, room: string, startTime: string, endTime: string, classType: string): number {
  // 提取 Studio 名称（第一个逗号前的内容）
  const studioName = studio.split(',')[0].trim();
  
  // 计算时长（小时）
  const start = new Date(\`2000-01-01 \${startTime}\`);
  const end = new Date(\`2000-01-01 \${endTime}\`);
  const durationHours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
  
`;

            studios.forEach(studio => {
                code += `  // ${studio.name}\n`;
                code += `  if (studioName === '${studio.name}') {\n`;
                code += `    switch (room) {\n`;
                studio.rooms.forEach(room => {
                    code += `      case '${room.number}':\n`;
                    code += `        return ${room.price} * durationHours; // ${room.size}m²，${room.price}円/小时\n`;
                });
                code += `      default:\n`;
                code += `        return ${studio.rooms[0]?.price || 1000} * durationHours; // 默认价格\n`;
                code += `    }\n  }\n\n`;
            });

            code += `  // 其他 Studio 的默认晚上价格\n`;
            code += `  return 1200 * durationHours; // 默认晚上每小时1200円\n`;
            code += `}\n\n`;

            code += `// 业务逻辑：根据 Studio 和 Room 判断 Max participants（学生人数 = 房间容量 - 1）\n`;
            code += `function getMaxParticipants(studio: string, room: string): number {\n`;
            code += `  // 提取 Studio 名称\n`;
            code += `  const studioName = studio.split(',')[0].trim();\n\n`;

            studios.forEach(studio => {
                code += `  // ${studio.name}\n`;
                code += `  if (studioName === '${studio.name}') {\n`;
                code += `    switch (room) {\n`;
                studio.rooms.forEach(room => {
                    const studentCapacity = room.capacity - 1;
                    code += `      case '${room.number}':\n`;
                    code += `        return ${studentCapacity}; // ${room.size}m²，适合${room.capacity}人，学生${studentCapacity}人\n`;
                });
                code += `      default:\n`;
                code += `        return ${(studio.rooms[0]?.capacity || 6) - 1}; // 默认学生人数\n`;
                code += `    }\n  }\n\n`;
            });

            code += `  return 5; // 其他 Studio 默认值（学生5人）\n`;
            code += `}\n`;

            document.getElementById('codeOutput').textContent = code;
        }

        async function updateBookingData() {
            const code = generateCodeContent(); // 获取生成的代码
            
            try {
                const response = await fetch('/update-bookingdata', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });
                
                if (response.ok) {
                    alert('bookingdata.ts 已成功更新！');
                } else {
                    const errorData = await response.json();
                    alert('更新失败：' + errorData.error);
                }
            } catch (error) {
                alert('更新失败：' + error.message);
            }
        }

        function generateCodeContent() {
            let code = `// 业务逻辑：根据 Studio 和 Room 判断 Studio cost（使用晚上价格）
function getStudioCost(studio: string, room: string, startTime: string, endTime: string, classType: string): number {
  // 提取 Studio 名称（第一个逗号前的内容）
  const studioName = studio.split(',')[0].trim();
  
  // 计算时长（小时）
  const start = new Date(\`2000-01-01 \${startTime}\`);
  const end = new Date(\`2000-01-01 \${endTime}\`);
  const durationHours = (end.getTime() - start.getTime()) / (1000 * 60 * 60);
  
`;

            studios.forEach(studio => {
                code += `  // ${studio.name}\n`;
                code += `  if (studioName === '${studio.name}') {\n`;
                code += `    switch (room) {\n`;
                studio.rooms.forEach(room => {
                    code += `      case '${room.number}':\n`;
                    code += `        return ${room.price} * durationHours; // ${room.size}m²，${room.price}円/小时\n`;
                });
                code += `      default:\n`;
                code += `        return ${studio.rooms[0]?.price || 1000} * durationHours; // 默认价格\n`;
                code += `    }\n  }\n\n`;
            });

            code += `  // 其他 Studio 的默认晚上价格\n`;
            code += `  return 1200 * durationHours; // 默认晚上每小时1200円\n`;
            code += `}\n\n`;

            code += `// 业务逻辑：根据 Studio 和 Room 判断 Max participants（学生人数 = 房间容量 - 1）\n`;
            code += `function getMaxParticipants(studio: string, room: string): number {\n`;
            code += `  // 提取 Studio 名称\n`;
            code += `  const studioName = studio.split(',')[0].trim();\n\n`;

            studios.forEach(studio => {
                code += `  // ${studio.name}\n`;
                code += `  if (studioName === '${studio.name}') {\n`;
                code += `    switch (room) {\n`;
                studio.rooms.forEach(room => {
                    const studentCapacity = room.capacity - 1;
                    code += `      case '${room.number}':\n`;
                    code += `        return ${studentCapacity}; // ${room.size}m²，适合${room.capacity}人，学生${studentCapacity}人\n`;
                });
                code += `      default:\n`;
                code += `        return ${(studio.rooms[0]?.capacity || 6) - 1}; // 默认学生人数\n`;
                code += `    }\n  }\n\n`;
            });

            code += `  return 5; // 其他 Studio 默认值（学生5人）\n`;
            code += `}\n`;

            return code;
        }

        // 页面加载时显示已保存的 Studio
        displayStudios();
    </script>
</body>
</html>
